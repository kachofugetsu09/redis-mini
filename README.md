# miniRedis - Enterprise-Grade Java Redis Implementation

[![Java](https://img.shields.io/badge/Java-8+-brightgreen.svg)](https://www.oracle.com/java/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Performance](https://img.shields.io/badge/Performance-415k%20ops%2Fsec-brightgreen.svg)]()
[![AOF](https://img.shields.io/badge/AOF-Batch%20Optimized-blue.svg)]()
[![Replication](https://img.shields.io/badge/Replication-Full%20PSYNC-success.svg)]()

miniRedis æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„ Redis æœåŠ¡å™¨å®ç°ï¼Œä½¿ç”¨ Java 8+ å’Œ Netty æ„å»ºã€‚é¡¹ç›®å®ç°äº†å®Œæ•´çš„ Redis æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬é«˜æ€§èƒ½çš„ AOF æŒä¹…åŒ–ã€ä¸»ä»å¤åˆ¶ã€ä»¥åŠä¼˜åŒ–çš„å†…éƒ¨æ•°æ®ç»“æ„ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç‰¹è‰²](#é¡¹ç›®ç‰¹è‰²)
- [å¿«é€Ÿå¯åŠ¨](#å¿«é€Ÿå¯åŠ¨)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [æ”¯æŒçš„å‘½ä»¤](#æ”¯æŒçš„å‘½ä»¤)
- [å†…éƒ¨æ•°æ®ç»“æ„](#å†…éƒ¨æ•°æ®ç»“æ„)
- [æŒä¹…åŒ–ç³»ç»Ÿ](#æŒä¹…åŒ–ç³»ç»Ÿ)
- [ä¸»ä»å¤åˆ¶](#ä¸»ä»å¤åˆ¶)
- [æ€§èƒ½åŸºå‡†](#æ€§èƒ½åŸºå‡†)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [è®¸å¯è¯](#è®¸å¯è¯)

## ğŸš€ é¡¹ç›®ç‰¹è‰²

### å·¥ä¸šçº§æ€§èƒ½
- **é«˜ååé‡**: AOF æ‰¹é‡å†™å…¥è¾¾åˆ° 415,000 å‘½ä»¤/ç§’
- **ä½å»¶è¿Ÿ**: å¹³å‡å†™å…¥å»¶è¿Ÿ < 1msï¼Œæ‰¹é‡ä¼˜åŒ–æå‡å»¶è¿Ÿ 75.49%
- **é«˜å¹¶å‘**: æ”¯æŒ 10+ çº¿ç¨‹å¹¶å‘å†™å…¥ï¼Œ86,957 å‘½ä»¤/ç§’ååé‡
- **æ™ºèƒ½èƒŒå‹**: 6MB èƒŒå‹é˜ˆå€¼ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼Œè‡ªåŠ¨è°ƒèŠ‚å†™å…¥é€Ÿåº¦

### ä¼ä¸šçº§å¯é æ€§
- **æ•°æ®å®‰å…¨**: 99.86%+ å´©æºƒæ¢å¤æˆåŠŸç‡ï¼Œ8-14ms å¿«é€Ÿæ¢å¤
- **ä¸€è‡´æ€§ä¿è¯**: æ”¯æŒåŸå­æ“ä½œã€äº‹åŠ¡è¯­ä¹‰å’Œæ•°æ®å®Œæ•´æ€§éªŒè¯
- **æ•…éšœæ¢å¤**: å®Œæ•´çš„ AOF é‡å†™ã€æ–­ç‚¹ç»­ä¼ å’Œå¢é‡æ¢å¤æœºåˆ¶
- **ç›‘æ§æ”¯æŒ**: è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡ã€å¿ƒè·³ç»Ÿè®¡å’ŒçŠ¶æ€ç›‘æ§

### å…ˆè¿›çš„æŠ€æœ¯æ¶æ„
- **å¼‚æ­¥ I/O**: åŸºäº Netty çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæ”¯æŒä¸‡çº§è¿æ¥
- **æ‰¹é‡ä¼˜åŒ–**: 16-50 å‘½ä»¤æ™ºèƒ½æ‰¹å¤„ç†ï¼Œ243.75% ååé‡æå‡
- **å†…å­˜é«˜æ•ˆ**: æ¸è¿›å¼å“ˆå¸Œè¡¨ã€è·³è¡¨ç´¢å¼•å’Œ SDS å­—ç¬¦ä¸²ä¼˜åŒ–
- **åè®®å…¼å®¹**: å®Œæ•´ RESP åè®®æ”¯æŒï¼Œä¸ Redis å®¢æˆ·ç«¯ 100% å…¼å®¹

## âš¡ å¿«é€Ÿå¯åŠ¨

### ç¯å¢ƒè¦æ±‚
- **Java**: 8+ 

### å•æœºæ¨¡å¼å¯åŠ¨

**ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨æœåŠ¡å™¨**ï¼š
```bash
# ç¼–è¯‘é¡¹ç›®
mvn clean compile

# è¿è¡Œå•æœºRedisæœåŠ¡å™¨ (localhost:6379)
java -cp target/classes site.hnfy258.RedisServerLauncher
```

**å…³é”®ç±»**: `RedisServerLauncher` - å•æœºæœåŠ¡å™¨å¯åŠ¨å™¨
- é»˜è®¤ç«¯å£: 6379
- é»˜è®¤æ•°æ®åº“æ•°é‡: 16
- æŒä¹…åŒ–: å¯ç”¨ RDBï¼ŒAOF å¯é…ç½®

### ä¸»ä»é›†ç¾¤æ¨¡å¼

**å¯åŠ¨å®Œæ•´çš„ä¸»ä»é›†ç¾¤**ï¼š
```bash
# å¯åŠ¨ä¸»ä»é›†ç¾¤ (ä¸»èŠ‚ç‚¹:6379, ä»èŠ‚ç‚¹:6380,6381)
java -cp target/classes site.hnfy258.RedisMsLauncher
```

**é›†ç¾¤æ¶æ„**ï¼š
- **ä¸»èŠ‚ç‚¹**: localhost:6379 (master-node)
- **ä»èŠ‚ç‚¹1**: localhost:6380 (slave-node1)  
- **ä»èŠ‚ç‚¹2**: localhost:6381 (slave-node2)
- **å¤åˆ¶æœºåˆ¶**: PSYNC åè®®ï¼Œæ”¯æŒå…¨é‡å’Œå¢é‡åŒæ­¥
- **å¿ƒè·³ç›‘æ§**: 1ç§’é—´éš”ï¼Œ3æ¬¡å¤±è´¥è§¦å‘é‡è¿

### æŒä¹…åŒ–é…ç½®

**åœ¨ RedisMiniServer ä¸­é…ç½®æŒä¹…åŒ–é€‰é¡¹**ï¼š
```java
// å¯ç”¨/ç¦ç”¨æŒä¹…åŒ–æœºåˆ¶
private static final boolean ENABLE_AOF = false;  // AOF æ—¥å¿—æŒä¹…åŒ–
private static final boolean ENABLE_RDB = true;   // RDB å¿«ç…§æŒä¹…åŒ–

// æ„é€ å‡½æ•°æ”¯æŒè‡ªå®šä¹‰ RDB æ–‡ä»¶å
RedisMiniServer server = new RedisMiniServer("localhost", 6379, "custom.rdb");
```

**æŒä¹…åŒ–ç‰¹æ€§**ï¼š
- **RDB**: äºŒè¿›åˆ¶å¿«ç…§ï¼Œå¿«é€Ÿå¯åŠ¨æ¢å¤
- **AOF**: å‘½ä»¤æ—¥å¿—ï¼Œæ•°æ®å®‰å…¨æ€§æ›´é«˜
- **æ”¯æŒåŒæ—¶å¯ç”¨**: æä¾›åŒé‡æ•°æ®ä¿æŠ¤
- **è‡ªåŠ¨æ¢å¤**: å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æŒä¹…åŒ–æ•°æ®

### æ–­çº¿é‡è¿æµ‹è¯•

**æµ‹è¯•ä¸»ä»å¤åˆ¶çš„å¥å£®æ€§**ï¼š
```bash
# å¯åŠ¨å¸¦é‡è¿æµ‹è¯•çš„ä¸»ä»é›†ç¾¤
java -cp target/classes site.hnfy258.RedisMsLauncherWithReconnect
```

**æµ‹è¯•åŠŸèƒ½**ï¼š
- è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œé‡è¿
- å¢é‡æ•°æ®åŒæ­¥éªŒè¯  
- å¿ƒè·³æœºåˆ¶å‹åŠ›æµ‹è¯•
- ç½‘ç»œä¸­æ–­æ¢å¤æµ‹è¯•

### å®¢æˆ·ç«¯è¿æ¥

**ä½¿ç”¨æ ‡å‡† Redis å®¢æˆ·ç«¯è¿æ¥**ï¼š
```bash
# ä½¿ç”¨ redis-cli è¿æ¥
redis-cli -h localhost -p 6379

# æµ‹è¯•åŸºæœ¬åŠŸèƒ½
127.0.0.1:6379> ping
PONG
127.0.0.1:6379> set test "Hello miniRedis"
OK
127.0.0.1:6379> get test
"Hello miniRedis"
```


## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    miniRedis æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Client Layer (RESP Protocol)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ RespDecoder â”‚ RespEncoder â”‚ RespCommandHandler          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Core Engine                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ RedisCore â”‚ CommandSystem â”‚ Database(16 DBs)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Structures                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Dict â”‚ SkipList â”‚ SDS â”‚ LinkedList â”‚ HashTable           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Persistence Layer                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AOF(BatchWriter) â”‚ RDB(Writer/Loader) â”‚ FileUtils       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Replication System                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PSYNC â”‚ ReplBackLog â”‚ HeartbeatManager â”‚ StateMachine    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Network Layer (Netty)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ NioEventLoopGroup â”‚ ChannelPipeline â”‚ Bootstrap          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è¯¦è§£

#### ğŸŒ ç½‘ç»œé€šä¿¡å±‚ (`server` & `protocal`)

**RESP åè®®å¤„ç†** - å®Œæ•´çš„ Redis åºåˆ—åŒ–åè®®æ”¯æŒï¼š
```java
// æ ¸å¿ƒç¼–è§£ç å™¨
site.hnfy258.server.handler.RespDecoder     // RESP åè®®è§£ç 
site.hnfy258.server.handler.RespEncoder     // RESP åè®®ç¼–ç   
site.hnfy258.server.handler.RespCommandHandler  // å‘½ä»¤å¤„ç†

// åè®®ç±»å‹å®ç°
site.hnfy258.protocal.SimpleString          // +OK\r\n
site.hnfy258.protocal.BulkString            // $6\r\nfoobar\r\n
site.hnfy258.protocal.RespArray             // *2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n
site.hnfy258.protocal.RespInteger           // :1000\r\n
site.hnfy258.protocal.Errors                // -Error message\r\n
```

**ç½‘ç»œç‰¹æ€§**ï¼š
- **å¼‚æ­¥ I/O**: Netty NioEventLoopGroupï¼ŒCPU æ ¸å¿ƒæ•° x2 å·¥ä½œçº¿ç¨‹
- **è¿æ¥æ± **: æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œä½èµ„æºå ç”¨
- **åè®®å…¼å®¹**: 100% Redis RESP åè®®å…¼å®¹
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯å“åº”å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶

#### âš¡ é«˜æ€§èƒ½æ•°æ®ç»“æ„ (`internal`)

**è·³è¡¨ (SkipList)** - æœ‰åºé›†åˆçš„æ ¸å¿ƒå®ç°ï¼š
```java
site.hnfy258.internal.SkipList<T extends Comparable<T>>

// æ ¸å¿ƒæ“ä½œ - O(log n) æ—¶é—´å¤æ‚åº¦
public SkipListNode<T> insert(double score, T member);
public boolean delete(double score, T member);
public List<SkipListNode<T>> getElementByRankRange(long start, long end);
public List<SkipListNode<T>> getElementByScoreRange(double min, double max);
```

**æ¸è¿›å¼å“ˆå¸Œè¡¨ (Dict)** - éé˜»å¡æ‰©å®¹æœºåˆ¶ï¼š
```java
site.hnfy258.internal.Dict<K,V>

private DictHashTable<K,V> ht0;  // ä¸»å“ˆå¸Œè¡¨
private DictHashTable<K,V> ht1;  // æ‰©å®¹æ—¶çš„ä¸´æ—¶å“ˆå¸Œè¡¨  
private int rehashIndex;         // æ¸è¿›å¼ rehash è¿›åº¦

// æ¯æ¬¡æ“ä½œæ—¶æ‰§è¡Œå°‘é‡ rehashï¼Œé¿å…é˜»å¡
private void rehashStep();
```

**ç®€å•åŠ¨æ€å­—ç¬¦ä¸² (SDS)** - å†…å­˜ä¼˜åŒ–çš„å­—ç¬¦ä¸²ï¼š
```java
site.hnfy258.internal.Sds

private byte[] bytes;    // å­—ç¬¦ä¸²å†…å®¹
private int len;         // å·²ä½¿ç”¨é•¿åº¦  
private int alloc;       // åˆ†é…çš„æ€»é•¿åº¦

// é¢„åˆ†é…ç­–ç•¥ï¼Œå‡å°‘å†…å­˜é‡åˆ†é…æ¬¡æ•°
public Sds append(byte[] extra);
```

#### ğŸ—ƒï¸ æ•°æ®ç±»å‹å®ç° (`datastructure`)

| æ•°æ®ç±»å‹ | å®ç°ç±» | åº•å±‚ç»“æ„ | ç‰¹æ€§ |
|---------|--------|----------|------|
| **String** | `RedisString` | SDS | äºŒè¿›åˆ¶å®‰å…¨ï¼ŒO(1)é•¿åº¦è·å– |
| **List** | `RedisList` | LinkedList | åŒå‘é“¾è¡¨ï¼ŒO(1)å¤´å°¾æ“ä½œ |
| **Set** | `RedisSet` | Dict | å“ˆå¸Œè¡¨ï¼ŒO(1)æˆå‘˜æ“ä½œ |
| **Hash** | `RedisHash` | Dict | åµŒå¥—å“ˆå¸Œè¡¨ï¼ŒO(1)å­—æ®µæ“ä½œ |
| **ZSet** | `RedisZset` | SkipList + Dict | O(log n)èŒƒå›´æŸ¥è¯¢ï¼ŒO(1)åˆ†æ•°æŸ¥æ‰¾ |

#### ğŸ¯ å‘½ä»¤ç³»ç»Ÿ (`command`)

**å‘½ä»¤æ¥å£è®¾è®¡**ï¼š
```java
site.hnfy258.command.Command

public interface Command {
    CommandType getType();           // å‘½ä»¤ç±»å‹è¯†åˆ«
    void setContext(Resp[] array);   // å‚æ•°æ³¨å…¥
    Resp handle();                   // å‘½ä»¤æ‰§è¡Œ
    boolean isWriteCommand();        // å†™å‘½ä»¤æ ‡è¯†(ç”¨äºä¸»ä»å¤åˆ¶)
}
```

**æ”¯æŒçš„å‘½ä»¤ç±»å‹**ï¼š
- **String**: `GET`, `SET` - åŸºç¡€é”®å€¼æ“ä½œ
- **List**: `LPUSH`, `LPOP`, `LRANGE` - åˆ—è¡¨æ“ä½œ
- **Set**: `SADD`, `SPOP`, `SREM` - é›†åˆæ“ä½œ
- **Hash**: `HSET`, `HGET`, `HDEL` - å“ˆå¸Œè¡¨æ“ä½œ
- **ZSet**: `ZADD`, `ZRANGE` - æœ‰åºé›†åˆæ“ä½œ
- **é€šç”¨**: `PING`, `SELECT` - è¿æ¥å’Œæ•°æ®åº“æ“ä½œ
- **æŒä¹…åŒ–**: `BGSAVE`, `BGREWRITEAOF` - åå°æŒä¹…åŒ–
- **å¤åˆ¶**: `PSYNC` - ä¸»ä»åŒæ­¥åè®®

## ğŸ“Š æ”¯æŒçš„å‘½ä»¤

### å‘½ä»¤å…¼å®¹æ€§çŸ©é˜µ

| ç±»å‹ | å‘½ä»¤ | å®ç°ç±» | åŠŸèƒ½æè¿° | æ—¶é—´å¤æ‚åº¦ |
|------|------|--------|----------|------------|
| **String** | `SET key value` | `site.hnfy258.command.impl.string.Set` | è®¾ç½®å­—ç¬¦ä¸²å€¼ | O(1) |
| | `GET key` | `site.hnfy258.command.impl.string.Get` | è·å–å­—ç¬¦ä¸²å€¼ | O(1) |
| **List** | `LPUSH key value [value ...]` | `site.hnfy258.command.impl.list.Lpush` | å·¦ä¾§æ’å…¥å…ƒç´  | O(N) |
| | `LPOP key` | `site.hnfy258.command.impl.list.Lpop` | å·¦ä¾§å¼¹å‡ºå…ƒç´  | O(1) |
| | `LRANGE key start stop` | `site.hnfy258.command.impl.list.Lrange` | èŒƒå›´æŸ¥è¯¢ | O(N) |
| **Set** | `SADD key member [member ...]` | `site.hnfy258.command.impl.set.Sadd` | æ·»åŠ æˆå‘˜ | O(N) |
| | `SPOP key [count]` | `site.hnfy258.command.impl.set.Spop` | éšæœºå¼¹å‡ºæˆå‘˜ | O(1) |
| | `SREM key member [member ...]` | `site.hnfy258.command.impl.set.Srem` | åˆ é™¤æˆå‘˜ | O(N) |
| **Hash** | `HSET key field value` | `site.hnfy258.command.impl.hash.Hset` | è®¾ç½®å“ˆå¸Œå­—æ®µ | O(1) |
| | `HGET key field` | `site.hnfy258.command.impl.hash.Hget` | è·å–å“ˆå¸Œå­—æ®µ | O(1) |
| | `HDEL key field [field ...]` | `site.hnfy258.command.impl.hash.Hdel` | åˆ é™¤å“ˆå¸Œå­—æ®µ | O(N) |
| **ZSet** | `ZADD key score member [score member ...]` | `site.hnfy258.command.impl.zset.Zadd` | æ·»åŠ æœ‰åºæˆå‘˜ | O(log N) |
| | `ZRANGE key start stop [WITHSCORES]` | `site.hnfy258.command.impl.zset.Zrange` | èŒƒå›´æŸ¥è¯¢ | O(log N + M) |
| **é€šç”¨** | `PING` | `site.hnfy258.command.impl.Ping` | æµ‹è¯•è¿æ¥ | O(1) |
| | `SELECT db` | `site.hnfy258.command.impl.Select` | é€‰æ‹©æ•°æ®åº“ | O(1) |
| **æŒä¹…åŒ–** | `BGSAVE` | `site.hnfy258.command.impl.aof.Bgsave` | åå°ä¿å­˜ RDB | O(N) |
| | `BGREWRITEAOF` | `site.hnfy258.command.impl.aof.Bgrewriteaof` | é‡å†™ AOF æ–‡ä»¶ | O(N) |
| **å¤åˆ¶** | `PSYNC runid offset` | `site.hnfy258.command.impl.cluster.Psync` | ä¸»ä»åŒæ­¥åè®® | O(1) |

### å‘½ä»¤æ‰©å±•ç‰¹æ€§

- **å‚æ•°éªŒè¯**: æ‰€æœ‰å‘½ä»¤éƒ½åŒ…å«å®Œæ•´çš„å‚æ•°éªŒè¯å’Œé”™è¯¯æç¤º
- **ç±»å‹æ£€æŸ¥**: ä¸¥æ ¼çš„æ•°æ®ç±»å‹æ£€æŸ¥ï¼Œé˜²æ­¢ç±»å‹æ··ç”¨é”™è¯¯
- **åŸå­æ“ä½œ**: å•ä¸ªå‘½ä»¤çš„åŸå­æ€§ä¿è¯
- **äº‹åŠ¡æ”¯æŒ**: ä¸ºæœªæ¥äº‹åŠ¡åŠŸèƒ½é¢„ç•™æ¥å£è®¾è®¡
- **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ ‡å‡† Redis é”™è¯¯æ ¼å¼

## ğŸ† å†…éƒ¨æ•°æ®ç»“æ„è¯¦è§£

### è·³è¡¨ (SkipList) - æœ‰åºé›†åˆçš„æ ¸å¿ƒ

**å®ç°ä½ç½®**: `site.hnfy258.internal.SkipList`

**æŠ€æœ¯ä¼˜åŠ¿**:
- **æ—¶é—´å¤æ‚åº¦**: æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾å‡ä¸º O(log n)
- **ç©ºé—´å±€éƒ¨æ€§**: æ¯”å¹³è¡¡æ ‘æ›´å¥½çš„ç¼“å­˜æ€§èƒ½ï¼Œå‡å°‘ CPU ç¼“å­˜ç¼ºå¤±
- **èŒƒå›´æŸ¥è¯¢**: å¤©ç„¶æ”¯æŒèŒƒå›´æŸ¥è¯¢å’Œæ’åºæ“ä½œï¼Œæ— éœ€é¢å¤–ç´¢å¼•
- **å®ç°ç®€å•**: æ¯”çº¢é»‘æ ‘ç­‰å¹³è¡¡æ ‘å®ç°æ›´ç®€å•ï¼Œç»´æŠ¤æˆæœ¬ä½
- **æ¦‚ç‡å¹³è¡¡**: åŸºäºéšæœºåŒ–çš„æ¦‚ç‡å¹³è¡¡ï¼Œé¿å…æœ€åæƒ…å†µ

**æ ¸å¿ƒæ“ä½œ**:
```java
// O(log n) å¤æ‚åº¦çš„æ ¸å¿ƒæ“ä½œ
public SkipListNode<T> insert(double score, T member);     // æ’å…¥å…ƒç´ 
public boolean delete(double score, T member);              // åˆ é™¤å…ƒç´   
public List<SkipListNode<T>> getElementByRankRange(long start, long end);  // æŒ‰æ’åèŒƒå›´æŸ¥è¯¢
public List<SkipListNode<T>> getElementByScoreRange(double min, double max); // æŒ‰åˆ†æ•°èŒƒå›´æŸ¥è¯¢
```

### æ¸è¿›å¼å“ˆå¸Œè¡¨ (Dict) - éé˜»å¡æ‰©å®¹

**å®ç°ä½ç½®**: `site.hnfy258.internal.Dict`

**è®¾è®¡ç†å¿µ**:
- **éé˜»å¡æ‰©å®¹**: é¿å…å¤§æ•°æ®é‡æ—¶çš„é•¿æ—¶é—´é˜»å¡ï¼Œä¿è¯æœåŠ¡å¯ç”¨æ€§
- **å†…å­˜æ•ˆç‡**: é€æ­¥è¿ç§»æ•°æ®ï¼Œé¿å…æ‰©å®¹æ—¶çš„å†…å­˜ä½¿ç”¨å³°å€¼
- **é«˜å¯ç”¨æ€§**: æ‰©å®¹æœŸé—´æŒç»­æä¾›æœåŠ¡ï¼Œä¸å½±å“æ­£å¸¸æ“ä½œ
- **è‡ªé€‚åº”**: æ ¹æ®è´Ÿè½½å› å­è‡ªåŠ¨è§¦å‘æ‰©å®¹å’Œæ”¶ç¼©

**æ ¸å¿ƒæœºåˆ¶**:
```java
private DictHashTable<K,V> ht0;  // ä¸»å“ˆå¸Œè¡¨
private DictHashTable<K,V> ht1;  // æ‰©å®¹æ—¶çš„ä¸´æ—¶å“ˆå¸Œè¡¨
private int rehashIndex;         // æ¸è¿›å¼ rehash è¿›åº¦è·Ÿè¸ª

// æ¯æ¬¡æ“ä½œæ—¶è¿›è¡Œå°‘é‡æ•°æ®è¿ç§»ï¼Œåˆ†æ‘Šæ‰©å®¹æˆæœ¬
private void rehashStep() {
    // æ¯æ¬¡æ“ä½œè¿ç§»1ä¸ªæ¡¶çš„æ•°æ®ï¼Œé¿å…å•æ¬¡é˜»å¡
}
```

### SDS å­—ç¬¦ä¸² (Simple Dynamic String) - å†…å­˜ä¼˜åŒ–

**å®ç°ä½ç½®**: `site.hnfy258.internal.Sds`

**æ€§èƒ½ç‰¹æ€§**:
- **O(1) é•¿åº¦è·å–**: é¢„å­˜å‚¨é•¿åº¦ä¿¡æ¯ï¼Œé¿å…éå†è®¡ç®—
- **äºŒè¿›åˆ¶å®‰å…¨**: æ”¯æŒä»»æ„äºŒè¿›åˆ¶æ•°æ®ï¼ŒåŒ…å«ç©ºå­—ç¬¦
- **å‡å°‘å†…å­˜åˆ†é…**: é¢„åˆ†é…ç­–ç•¥å’Œæƒ°æ€§é‡Šæ”¾ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨
- **å†…å­˜å¯¹é½**: ä¼˜åŒ–å†…å­˜è®¿é—®æ¨¡å¼ï¼Œæå‡ç¼“å­˜å‘½ä¸­ç‡

**æ ¸å¿ƒä¼˜åŒ–**:
```java
private byte[] bytes;    // å­—ç¬¦ä¸²å†…å®¹
private int len;         // å·²ä½¿ç”¨é•¿åº¦ï¼ŒO(1)è·å–
private int alloc;       // åˆ†é…çš„æ€»é•¿åº¦

// æ™ºèƒ½é¢„åˆ†é…ç­–ç•¥
public Sds append(byte[] extra) {
    // 1. å°å­—ç¬¦ä¸²(<1MB): é¢„åˆ†é…2å€ç©ºé—´
    // 2. å¤§å­—ç¬¦ä¸²(>=1MB): é¢„åˆ†é…1MBé¢å¤–ç©ºé—´
    // 3. å‡å°‘å†…å­˜é‡åˆ†é…æ¬¡æ•°ï¼Œæå‡æ€§èƒ½
}
```

### æ•°æ®ç»“æ„æ—¶é—´å¤æ‚åº¦

| æ•°æ®ç»“æ„ | æ’å…¥ | åˆ é™¤ | æŸ¥æ‰¾ | èŒƒå›´æŸ¥è¯¢ |
|---------|------|------|------|----------|
| **SkipList** | O(log n) | O(log n) | O(log n) | O(log n + k) |
| **Dict** | O(1) | O(1) | O(1) | N/A |
| **SDS** | O(n) | O(1) | O(n) | N/A |


## ğŸ’¾ æŒä¹…åŒ–

### RDB å¿«ç…§
- **è§¦å‘æ–¹å¼**: `BGSAVE` å‘½ä»¤æˆ–é…ç½®å®šæ—¶ä¿å­˜
- **æ–‡ä»¶æ ¼å¼**: äºŒè¿›åˆ¶æ ¼å¼ï¼Œç´§å‡‘é«˜æ•ˆ
- **æ¢å¤é€Ÿåº¦**: å¯åŠ¨æ—¶å¿«é€ŸåŠ è½½
- **å¤šæ•°æ®ç±»å‹æ”¯æŒ**: Stringã€Listã€Setã€Hashã€ZSet
- **æ•°æ®åº“éš”ç¦»**: æ”¯æŒå¤šæ•°æ®åº“çš„ç‹¬ç«‹ä¿å­˜å’ŒåŠ è½½
- **æ–‡ä»¶å®Œæ•´æ€§**: å†…ç½®å¤´éƒ¨éªŒè¯å’ŒEOFæ ‡è®°
- **ä¸´æ—¶æ–‡ä»¶æœºåˆ¶**: æ”¯æŒä¸»ä»å¤åˆ¶çš„ä¸´æ—¶RDBç”Ÿæˆ

#### RDB æ¶æ„è®¾è®¡

**æ ¸å¿ƒç»„ä»¶ï¼š**
- `RdbManager` - RDBç®¡ç†å™¨ï¼Œç»Ÿä¸€åè°ƒè¯»å†™æ“ä½œ
- `RdbWriter` - æ•°æ®å†™å…¥å™¨ï¼Œæ”¯æŒäºŒè¿›åˆ¶åºåˆ—åŒ–
- `RdbLoader` - æ•°æ®åŠ è½½å™¨ï¼Œæ”¯æŒäºŒè¿›åˆ¶ååºåˆ—åŒ–
- `RdbUtils` - å·¥å…·ç±»ï¼Œæä¾›ç¼–ç /è§£ç åŸºç¡€åŠŸèƒ½
- `RdbConstants` - å¸¸é‡å®šä¹‰ï¼ŒåŒ…å«æ“ä½œç å’Œæ•°æ®ç±»å‹

**æ–‡ä»¶æ ¼å¼ç»“æ„ï¼š**
```java
// RDB æ–‡ä»¶æ ¼å¼
REDIS0009                    // 9å­—èŠ‚å¤´éƒ¨æ ‡è¯†
[SELECT-DB] [DB-ID]         // æ•°æ®åº“é€‰æ‹©æ ‡è®°
[TYPE] [KEY] [VALUE]        // æ•°æ®æ¡ç›®
...                         // æ›´å¤šæ•°æ®æ¡ç›®
[EOF] [CHECKSUM]            // ç»“æŸæ ‡è®°å’Œæ ¡éªŒå’Œ
```

**æ•°æ®ç±»å‹ç¼–ç ï¼š**
```java
public static final byte STRING_TYPE = (byte) 0;   // å­—ç¬¦ä¸²ç±»å‹
public static final byte LIST_TYPE = (byte) 1;     // åˆ—è¡¨ç±»å‹  
public static final byte SET_TYPE = (byte) 2;      // é›†åˆç±»å‹
public static final byte ZSET_TYPE = (byte) 3;     // æœ‰åºé›†åˆç±»å‹
public static final byte HASH_TYPE = (byte) 4;     // å“ˆå¸Œç±»å‹
public static final byte RDB_OPCODE_SELECTDB = (byte) 254;  // æ•°æ®åº“é€‰æ‹©
public static final byte RDB_OPCODE_EOF = (byte) 255;       // æ–‡ä»¶ç»“æŸ
```

**é•¿åº¦ç¼–ç ä¼˜åŒ–ï¼š**
- å°äº64çš„æ•°å­—ç”¨1å­—èŠ‚ç¼–ç 
- å°äº16384çš„æ•°å­—ç”¨2å­—èŠ‚ç¼–ç   
- æ›´å¤§çš„æ•°å­—ç”¨4å­—èŠ‚ç¼–ç 
- æœ‰æ•ˆå‡å°‘æ–‡ä»¶å¤§å°

### AOF æ—¥å¿—
- **æ‰¹é‡å†™å…¥**: å¼‚æ­¥æ‰¹å¤„ç†æœºåˆ¶ï¼Œæå‡å†™å…¥æ€§èƒ½
- **åå°é‡å†™**: æ”¯æŒ `BGREWRITEAOF` å‘½ä»¤ï¼Œå‹ç¼©AOFæ–‡ä»¶å¤§å°
- **ç¼“å†²åŒºç®¡ç†**: é‡å†™æœŸé—´çš„å‘½ä»¤ç¼“å†²å’Œåº”ç”¨æœºåˆ¶
- **èƒŒå‹æ§åˆ¶**: æ™ºèƒ½èƒŒå‹å¤„ç†ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- **æ•…éšœæ¢å¤**: å®Œæ•´çš„å´©æºƒæ¢å¤å’Œæ•°æ®ä¸€è‡´æ€§éªŒè¯
- **æ€§èƒ½ä¼˜åŒ–**: å¤§å‘½ä»¤é˜ˆå€¼å¤„ç†ã€å¯é…ç½®åˆ·ç›˜é—´éš”
- **æ–‡ä»¶å®‰å…¨**: åŸå­æ–‡ä»¶æ›¿æ¢ã€å¤‡ä»½æ¢å¤æœºåˆ¶
- **ç£ç›˜é¢„åˆ†é…**: 4MBé¢„åˆ†é…æœºåˆ¶ï¼Œå‡å°‘æ–‡ä»¶ç¢ç‰‡ï¼Œæå‡å†™å…¥æ€§èƒ½

#### AOF æ¶æ„è®¾è®¡

**æ ¸å¿ƒç»„ä»¶ï¼š**
- `AofManager` - AOFç®¡ç†å™¨ï¼Œç»Ÿä¸€åè°ƒå„ç»„ä»¶
- `AofWriter` - æ ¸å¿ƒå†™å…¥å™¨ï¼Œæ”¯æŒé‡å†™å’Œç¼“å†²
- `AofBatchWriter` - æ‰¹é‡å†™å…¥å™¨ï¼Œå¼‚æ­¥æ‰¹å¤„ç†ä¼˜åŒ–
- `AofLoader` - æ–‡ä»¶åŠ è½½å™¨ï¼Œæ”¯æŒå¤§æ–‡ä»¶åˆ†å—è¯»å–
- `AofUtils` - å·¥å…·ç±»ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹çš„AOFåºåˆ—åŒ–

**ç£ç›˜é¢„åˆ†é…æœºåˆ¶ï¼š**
```java
// é¢„åˆ†é…é…ç½®
private static final int DEFAULT_PREALLOCATE_SIZE = 4 * 1024 * 1024;  // 4MBé¢„åˆ†é…

// é¢„åˆ†é…æµç¨‹
1. æ–‡ä»¶åˆ›å»ºæ—¶é¢„å…ˆåˆ†é…4MBç£ç›˜ç©ºé—´
2. å†™å…¥æ“ä½œåœ¨é¢„åˆ†é…ç©ºé—´å†…è¿›è¡Œï¼Œé¿å…é¢‘ç¹æ‰©å±•
3. ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨æ‰©å±•ï¼Œä¿æŒè¿ç»­æ€§
4. æ–‡ä»¶å…³é—­æ—¶æˆªæ–­åˆ°å®é™…æ•°æ®å¤§å°ï¼Œé‡Šæ”¾å¤šä½™ç©ºé—´
```

**é¢„åˆ†é…ä¼˜åŠ¿ï¼š**
- **å‡å°‘ç£ç›˜ç¢ç‰‡**: è¿ç»­ç©ºé—´åˆ†é…ï¼Œæå‡ç£ç›˜I/Oæ•ˆç‡
- **é™ä½å†™å…¥å»¶è¿Ÿ**: é¿å…æ–‡ä»¶æ‰©å±•çš„ç³»ç»Ÿè°ƒç”¨å¼€é”€
- **ä¼˜åŒ–æ‰¹é‡å†™å…¥**: æ”¯æŒé«˜é¢‘å†™å…¥åœºæ™¯çš„æ€§èƒ½éœ€æ±‚
- **Kafkaé£æ ¼ä¼˜åŒ–**: å‚è€ƒKafkaçš„ç£ç›˜é¢„åˆ†é…è®¾è®¡æ¨¡å¼

**æ€§èƒ½ç‰¹æ€§ï¼š**
```java
// æ‰¹é‡å†™å…¥é…ç½®
public static final int MIN_BATCH_SIZE = 16;          // æœ€å°æ‰¹å¤„ç†å¤§å°
public static final int MAX_BATCH_SIZE = 50;          // æœ€å¤§æ‰¹å¤„ç†å¤§å°
public static final int LARGE_COMMAND_THRESHOLD = 512 * 1024;  // å¤§å‘½ä»¤é˜ˆå€¼

// èƒŒå‹æ§åˆ¶
private static final int DEFAULT_BACKPRESSURE_THRESHOLD = 6 * 1024 * 1024;  // 6MB
private static final int DEFAULT_QUEUE_SIZE = 1000;    // é»˜è®¤é˜Ÿåˆ—å¤§å°
```

**é‡å†™æœºåˆ¶ï¼š**
- åå°çº¿ç¨‹æ‰§è¡Œï¼Œä¸é˜»å¡æ­£å¸¸æ“ä½œ
- é‡å†™æœŸé—´æ–°å‘½ä»¤ç¼“å†²åˆ°é˜Ÿåˆ—
- åŸå­æ–‡ä»¶æ›¿æ¢ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
- æ”¯æŒé‡å†™å¤±è´¥åçš„è‡ªåŠ¨æ¢å¤

## ğŸ”„ ä¸»ä»å¤åˆ¶

miniRedis å®ç°äº†å®Œæ•´çš„ Redis ä¸»ä»å¤åˆ¶æœºåˆ¶ï¼Œæ”¯æŒ PSYNC åè®®ã€æ–­çº¿é‡è¿å’Œå‘½ä»¤ä¼ æ’­ï¼Œç¡®ä¿æ•°æ®åœ¨å¤šä¸ªèŠ‚ç‚¹é—´çš„ä¸€è‡´æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **5çŠ¶æ€å¤åˆ¶çŠ¶æ€æœº**: DISCONNECTED â†’ CONNECTING â†’ SYNCING â†’ STREAMING â†’ ERROR
- **PSYNCåè®®**: æ”¯æŒå…¨é‡åŒæ­¥å’Œéƒ¨åˆ†é‡åŒæ­¥  
- **å¤åˆ¶ç§¯å‹ç¼“å†²åŒº**: 1MBç¯å½¢ç¼“å†²åŒºï¼Œæ”¯æŒæ–­çº¿é‡è¿æ—¶çš„å¢é‡åŒæ­¥
- **å¿ƒè·³ç›‘æ§**: 1ç§’é—´éš”å¿ƒè·³æ£€æµ‹ï¼Œè‡ªåŠ¨æ•…éšœå‘ç°å’Œé‡è¿
- **å‘½ä»¤ä¼ æ’­**: å®æ—¶ä¼ æ’­å†™å‘½ä»¤åˆ°æ‰€æœ‰ä»èŠ‚ç‚¹
- **åç§»é‡ç®¡ç†**: ç²¾ç¡®çš„å¤åˆ¶åç§»é‡è·Ÿè¸ªå’ŒåŒæ­¥

### æ¶æ„è®¾è®¡

#### æ ¸å¿ƒç»„ä»¶

**èŠ‚ç‚¹ç®¡ç†ï¼š**
- `RedisNode` - ä¸»ä»èŠ‚ç‚¹æ ¸å¿ƒå®ç°ï¼Œç®¡ç†è¿æ¥å’ŒçŠ¶æ€
- `NodeState` - èŠ‚ç‚¹çŠ¶æ€ç®¡ç†ï¼Œç»´æŠ¤ä¸»ä»å…³ç³»å’Œè¿æ¥ä¿¡æ¯

**å¤åˆ¶ç®¡ç†ï¼š**
- `ReplicationManager` - å¤åˆ¶åè°ƒå™¨ï¼Œå¤„ç†å…¨é‡/éƒ¨åˆ†åŒæ­¥
- `ReplicationStateMachine` - 5çŠ¶æ€å¤åˆ¶çŠ¶æ€æœºï¼Œç®¡ç†çŠ¶æ€è½¬æ¢
- `ReplicationHandler` - RESPåè®®å¤åˆ¶æ¶ˆæ¯å¤„ç†å™¨
- `ReplBackLog` - 1MBç¯å½¢å¤åˆ¶ç§¯å‹ç¼“å†²åŒº

**å¿ƒè·³ç›‘æ§ï¼š**
- `HeartbeatManager` - å¿ƒè·³ç®¡ç†å™¨ï¼Œç›‘æ§è¿æ¥å¥åº·çŠ¶æ€
- `HeartbeatStats` - å¿ƒè·³ç»Ÿè®¡ä¿¡æ¯

### å¤åˆ¶æµç¨‹

1. **è¿æ¥å»ºç«‹**: ä»èŠ‚ç‚¹è¿æ¥ä¸»èŠ‚ç‚¹å¹¶å‘é€ PSYNC å‘½ä»¤
2. **å…¨é‡åŒæ­¥**: ä¸»èŠ‚ç‚¹ç”ŸæˆRDBå¿«ç…§å¹¶ä¼ è¾“ç»™ä»èŠ‚ç‚¹  
3. **å¢é‡åŒæ­¥**: å®æ—¶ä¼ æ’­å†™å‘½ä»¤åˆ°ä»èŠ‚ç‚¹
4. **éƒ¨åˆ†é‡åŒæ­¥**: æ–­çº¿é‡è¿æ—¶æ ¹æ®åç§»é‡è¿›è¡Œå¢é‡åŒæ­¥
5. **å¿ƒè·³ç›‘æ§**: å®šæœŸå‘é€PINGå‘½ä»¤æ£€æµ‹è¿æ¥çŠ¶æ€

### é…ç½®ç¤ºä¾‹

#### å¯åŠ¨ä¸»ä»é›†ç¾¤
å¯åŠ¨å¯åŠ¨ç±» RedisMsLauncher
#### æ–­çº¿é‡è¿æµ‹è¯•

é¡¹ç›®æä¾› `RedisMsLauncherWithReconnect` ç”¨äºæµ‹è¯•æ–­çº¿é‡è¿åŠŸèƒ½ï¼š


### æŠ€æœ¯ç‰¹å¾

- **å¿ƒè·³é—´éš”**: 1ç§’ï¼Œå¤±è´¥3æ¬¡è§¦å‘é‡è¿
- **ç¼“å†²åŒºå¤§å°**: 1MBç¯å½¢ç¼“å†²åŒº  
- **åŒæ­¥æ–¹å¼**: å…¨é‡RDB + å¢é‡å‘½ä»¤æµ
- **æ•…éšœæ¢å¤**: è‡ªåŠ¨æ£€æµ‹å’Œé‡è¿

## âš¡ æ€§èƒ½åŸºå‡†

### AOF æŒä¹…åŒ–æ€§èƒ½æµ‹è¯•

> ğŸ“‹ **æµ‹è¯•è¯´æ˜**: ä»¥ä¸‹æ€§èƒ½æ•°æ®åŸºäºå®é™…æµ‹è¯•ç¯å¢ƒè·å¾—ï¼Œæµ‹è¯•ä»£ç ä½äº `AofExtremeCaseTest.java`

#### é«˜é¢‘å†™å…¥æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: 10ä¸‡æ¡SETå‘½ä»¤è¿ç»­å†™å…¥
```
æµ‹è¯•ç¯å¢ƒ: æœ¬åœ°ç¯å¢ƒï¼ŒSSDå­˜å‚¨
å‘½ä»¤ç±»å‹: SET key{i} value{i} (i=0â†’100,000)
```

**æ€§èƒ½æŒ‡æ ‡**:
- **å†™å…¥é€Ÿåº¦**: 414,938 å‘½ä»¤/ç§’
- **æ€»è€—æ—¶**: 241ms
- **æ•°æ®æ¢å¤**: 50msæ¢å¤10ä¸‡æ¡è®°å½•
- **æ–‡ä»¶å¤§å°**: 4.3MB

#### å¹¶å‘å†™å…¥æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: 10çº¿ç¨‹å¹¶å‘ï¼Œæ¯çº¿ç¨‹1000æ¡å‘½ä»¤
```
çº¿ç¨‹æ•°: 10ä¸ªå¹¶å‘çº¿ç¨‹
æ¯çº¿ç¨‹å‘½ä»¤æ•°: 1,000æ¡SETå‘½ä»¤
æ€»å‘½ä»¤æ•°: 10,000æ¡
```

**æ€§èƒ½æŒ‡æ ‡**:
- **å†™å…¥é€Ÿåº¦**: 86,957 å‘½ä»¤/ç§’
- **æ€»è€—æ—¶**: 115ms
- **æˆåŠŸç‡**: 100% (10,000/10,000)
- **æ•°æ®æ¢å¤**: 107msæ¢å¤9,985æ¡è®°å½•

#### æ‰¹é‡å†™å…¥vsç›´æ¥å†™å…¥å¯¹æ¯”

**æµ‹è¯•åœºæ™¯**: åŒç­‰æ•°æ®é‡ä¸‹çš„ä¸¤ç§å†™å…¥æ¨¡å¼å¯¹æ¯”

| å†™å…¥æ¨¡å¼ | ååé‡ | å‘½ä»¤å¤„ç†é€Ÿç‡ | å†™å…¥æ—¶é—´ | å¹³å‡å»¶è¿Ÿ |
|---------|--------|--------------|----------|----------|
| **æ‰¹é‡å†™å…¥** | 52.42 MB/s | 1,041,667 å‘½ä»¤/ç§’ | 96ms | 0.001ms |
| **ç›´æ¥å†™å…¥** | 15.25 MB/s | 303,030 å‘½ä»¤/ç§’ | 330ms | 0.003ms |

**æ€§èƒ½æå‡**:
- **ååé‡æå‡**: 243.75% (æ‰¹é‡å†™å…¥ç›¸æ¯”ç›´æ¥å†™å…¥)
- **å»¶è¿Ÿé™ä½**: 75.49% (æ‰¹é‡å†™å…¥å»¶è¿Ÿæ›´ä½)
- **å¹³å‡æ‰¹æ¬¡å¤§å°**: 844æ¡å‘½ä»¤/æ‰¹æ¬¡

#### å´©æºƒæ¢å¤æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: æ¨¡æ‹Ÿç¨‹åºå´©æºƒåçš„æ•°æ®æ¢å¤èƒ½åŠ›
```
æµ‹è¯•æ•°æ®: 5,000æ¡å‘½ä»¤
å´©æºƒæ¨¡æ‹Ÿ: å¼ºåˆ¶ä¸­æ–­AOFå†™å…¥è¿‡ç¨‹
æ¢å¤æµ‹è¯•: é‡å¯åæ•°æ®å®Œæ•´æ€§éªŒè¯
```

**æ¢å¤æŒ‡æ ‡**:
- **æ¢å¤æ—¶é—´**: 8-14ms (5,000æ¡å‘½ä»¤)
- **æ•°æ®å®Œæ•´æ€§**: 99.86% (4,993/5,000æ¡æˆåŠŸæ¢å¤)
- **æ¢å¤æˆåŠŸç‡**: 99.86%

#### èƒŒå‹æ§åˆ¶æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: é«˜è´Ÿè½½ä¸‹çš„èƒŒå‹æ§åˆ¶æœºåˆ¶éªŒè¯
```
èƒŒå‹è§¦å‘é˜ˆå€¼: 6MB
é˜Ÿåˆ—å¤§å°é™åˆ¶: 1,000æ¡å‘½ä»¤
æµ‹è¯•è´Ÿè½½: æŒç»­é«˜é¢‘å†™å…¥
```

**èƒŒå‹æŒ‡æ ‡**:
- **èƒŒå‹è§¦å‘æ¬¡æ•°**: 38æ¬¡
- **æœ€å¤§å»¶è¿Ÿ**: 53.816ms (èƒŒå‹è§¦å‘æ—¶)
- **å¹³å‡å»¶è¿Ÿ**: 0.613ms (èƒŒå‹çŠ¶æ€ä¸‹)
- **é˜Ÿåˆ—ç®¡ç†**: è‡ªåŠ¨è°ƒèŠ‚å†™å…¥é€Ÿåº¦ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º

### AOF ä¼˜åŒ–æœºåˆ¶

- **æ‰¹å¤„ç†**: 16-50æ¡å‘½ä»¤æ‰¹é‡å¤„ç†ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨
- **å¼‚æ­¥å†™å…¥**: ä¸“ç”¨å†™å…¥çº¿ç¨‹ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
- **èƒŒå‹æ§åˆ¶**: 6MBé˜ˆå€¼ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- **å¤§å‘½ä»¤ä¼˜åŒ–**: 512KBä»¥ä¸Šå‘½ä»¤ç›´æ¥å†™å…¥ï¼Œé¿å…é˜Ÿåˆ—ç§¯å‹
- **å®šæ—¶åˆ·ç›˜**: å¯é…ç½®åˆ·ç›˜é—´éš”ï¼Œå¹³è¡¡æ€§èƒ½ä¸å®‰å…¨æ€§
## ğŸ‘©â€ğŸ’» å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„
```
src/main/java/site/hnfy258/
â”œâ”€â”€ aof/                    # AOF æŒä¹…åŒ–
â”‚   â”œâ”€â”€ AofManager.java     # AOF ç®¡ç†å™¨
â”‚   â”œâ”€â”€ AofLoader.java      # AOF æ–‡ä»¶åŠ è½½å™¨
â”‚   â””â”€â”€ writer/             # å†™å…¥å™¨ç»„ä»¶
â”œâ”€â”€ cluster/                # ä¸»ä»å¤åˆ¶
â”‚   â”œâ”€â”€ RedisNode.java      # èŠ‚ç‚¹ç®¡ç†
â”‚   â”œâ”€â”€ ReplicationManager.java  # å¤åˆ¶ç®¡ç†å™¨
â”‚   â””â”€â”€ heartbeat/          # å¿ƒè·³ç›‘æ§
â”œâ”€â”€ rdb/                    # RDB å¿«ç…§
â”‚   â”œâ”€â”€ RdbManager.java     # RDB ç®¡ç†å™¨
â”‚   â”œâ”€â”€ RdbWriter.java      # RDB å†™å…¥å™¨
â”‚   â””â”€â”€ RdbLoader.java      # RDB åŠ è½½å™¨
â”œâ”€â”€ command/                # å‘½ä»¤å¤„ç†
â”œâ”€â”€ dataStruct/             # æ•°æ®ç»“æ„
â”œâ”€â”€ server/                 # æœåŠ¡å™¨æ ¸å¿ƒ
â””â”€â”€ util/                   # å·¥å…·ç±»
```

### æ„å»ºä¸æµ‹è¯•
```bash
# ç¼–è¯‘é¡¹ç›®
mvn clean compile

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
mvn test

# è¿è¡Œ AOF æ€§èƒ½æµ‹è¯•
mvn test -Dtest=AofExtremeCaseTest

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
mvn test -Dmaven.test.failure.ignore=true surefire-report:report
```

### æ€§èƒ½æµ‹è¯•
é¡¹ç›®åŒ…å«å®Œæ•´çš„æ€§èƒ½æµ‹è¯•å¥—ä»¶ï¼Œä½äº `src/test/java/site/hnfy258/aof/writer/AofExtremeCaseTest.java`ï¼š

- **é«˜é¢‘å†™å…¥æµ‹è¯•**: 10ä¸‡æ¡å‘½ä»¤è¿ç»­å†™å…¥
- **å¹¶å‘å†™å…¥æµ‹è¯•**: å¤šçº¿ç¨‹å¹¶å‘å†™å…¥éªŒè¯
- **æ‰¹é‡ä¼˜åŒ–æµ‹è¯•**: æ‰¹é‡vsç›´æ¥å†™å…¥å¯¹æ¯”
- **å´©æºƒæ¢å¤æµ‹è¯•**: æ•°æ®å®Œæ•´æ€§å’Œæ¢å¤æ—¶é—´éªŒè¯
- **èƒŒå‹æ§åˆ¶æµ‹è¯•**: é«˜è´Ÿè½½ä¸‹çš„èƒŒå‹æœºåˆ¶éªŒè¯

### é…ç½®è¯´æ˜
```java
// AOF é…ç½®å‚æ•°
public static final int MIN_BATCH_SIZE = 16;          // æœ€å°æ‰¹é‡å¤§å°
public static final int MAX_BATCH_SIZE = 50;          // æœ€å¤§æ‰¹é‡å¤§å°
public static final int LARGE_COMMAND_THRESHOLD = 512 * 1024;  // å¤§å‘½ä»¤é˜ˆå€¼
public static final int DEFAULT_BACKPRESSURE_THRESHOLD = 6 * 1024 * 1024;  // èƒŒå‹é˜ˆå€¼

// å¤åˆ¶é…ç½®å‚æ•°
public static final int HEARTBEAT_INTERVAL = 1000;    // å¿ƒè·³é—´éš” (ms)
public static final int REPL_BACKLOG_SIZE = 1024 * 1024;  // å¤åˆ¶ç¼“å†²åŒºå¤§å°
```

## ğŸ›£ï¸ å¼€å‘è®¡åˆ’

### è¿‘æœŸç›®æ ‡
- [x] **å®Œå–„ AOF æŒä¹…åŒ–** - å·²å®ç°æ‰¹é‡å†™å…¥ã€åå°é‡å†™ã€æ•…éšœæ¢å¤
- [x] **ä¸»ä»å¤åˆ¶** - å·²å®ç°PSYNCåè®®ã€5çŠ¶æ€æœºã€æ–­çº¿é‡è¿æœºåˆ¶
- [ ] æ·»åŠ æ›´å¤š Redis å‘½ä»¤
- [ ] å®ç°è¿‡æœŸç­–ç•¥
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

### é•¿æœŸç›®æ ‡
- [ ] é›†ç¾¤æ¨¡å¼ (Redis Cluster)
- [ ] å“¨å…µæ¨¡å¼
- [ ] å‘å¸ƒ/è®¢é˜…æ¨¡å¼
- [ ] æµæ•°æ®ç±»å‹ (Stream)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿æ‰€æœ‰å½¢å¼çš„è´¡çŒ®ï¼š

1. **é—®é¢˜åé¦ˆ**: å‘ç° bug æˆ–æœ‰æ”¹è¿›å»ºè®®
2. **ä»£ç è´¡çŒ®**: æäº¤ Pull Request
3. **æ–‡æ¡£å®Œå–„**: æ”¹è¿›æ–‡æ¡£å’Œç¤ºä¾‹
4. **æµ‹è¯•ç”¨ä¾‹**: æ·»åŠ æ›´å¤šæµ‹è¯•åœºæ™¯


## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

- Redis å®˜æ–¹å›¢é˜Ÿæä¾›çš„ä¼˜ç§€è®¾è®¡ç†å¿µ
- Netty å›¢é˜Ÿæä¾›çš„é«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶
- å¼€æºç¤¾åŒºçš„å®è´µå»ºè®®å’Œè´¡çŒ®

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä¸€ä¸ª Starï¼

ğŸ“§ è”ç³»æ–¹å¼: [2494946808@qq.com]
