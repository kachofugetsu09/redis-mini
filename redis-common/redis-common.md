# Redis Mini - Common 公共模块

## 模块概览

`redis-common` 模块是 `redis-mini` 项目的基石。它提供了一系列高性能、Redis风格的核心数据结构和通用工具类，是整个系统的基础。本模块的设计深入参考了 Redis 的内部实现，重点关注内存效率、性能和二进制安全。

`redis-mini` 项目中的所有其他模块（包括 `redis-core`, `redis-persistence`, `redis-replication` 等）都依赖于此模块提供的健壮且经过优化的组件。

---

## 核心组件

本模块包含了精心设计和实现的数据结构，它们是 Redis 高性能与强大功能的核心。


### 1. `RedisBytes`

一个高性能、不可变的字节数组封装类，专为 Redis 操作优化。它在整个系统中作为键（Key）和值（Value）的主要载体。

**核心特性:**
* **命令池缓存**: 预创建并缓存常用的Redis命令（如 `GET`, `SET`），显著减少高频命令的对象创建开销。
* **惰性字符串缓存**: 其 `String` 形式按需创建并缓存，避免了不必要的 `byte[]` 到 `String` 的重复转换。
* **零拷贝访问**: 为受信任的内部组件提供 `getBytesUnsafe()` 方法，无需防御性拷贝即可访问底层字节数组，从而提升序列化和网络传输的性能。
* **预计算哈希码**: 哈希码在创建时一次性计算并缓存，加速在 `HashMap` 或 `Dict` 中的查找效率。

### 2. `Sds` (Simple Dynamic String)

一个高度优化的、Redis风格的动态字符串实现。与标准的 Java `String` 对象不同，`Sds` 是可变的，专为高频修改操作设计。

**核心特性:**
* **二进制安全**: 可以存储包括 `\0` 在内的任意二进制数据，不会造成数据截断或损坏。
* **O(1) 复杂度获取长度**: `Sds` 结构中直接保存了字符串的长度，获取长度的操作是常数时间复杂度，避免了C字符串那样需要遍历到结尾的低效操作。
* **智能预分配**: 在进行字符串追加等修改操作时，`Sds` 会采用智能的预分配策略（空间预分配），从而减少内存重分配的次数，提升性能。
* **自动类型升级**: 内部根据字符串长度使用不同的头部（`Sds8`, `Sds16`, `Sds32`），在字符串增长时自动升级到底层类型，最大限度地减少内存开销。


### 3. `Dict` (字典 / 哈希表)

一个线程安全的、Redis风格的哈希表实现，专为单写入、多读取的并发场景优化。这是用于存储Redis所有键值对的核心数据结构。

**核心特性:**
* **渐进式 Rehash**: 避免在哈希表扩容或缩容时长时间阻塞服务。数据迁移通过在后续的访问和操作中分小步、增量式地完成。
* **版本化快照**: 采用基于版本号的写时复制（Copy-on-Write）机制。这允许后台线程（例如RDB持久化或AOF重写）创建数据的一个完全一致的快照，而无需阻塞正在处理命令的主线程。
* **为单线程写入优化**: 遵循 Redis 模型，所有写操作都是串行化的，这简化了并发控制逻辑，同时依然能提供出色的并发读取性能。

### 4. `SkipList` (跳表)

一个经过改进的跳表实现，是有序集合（Sorted Set / `zset`）类型的核心。它提供了高效的、有序的数据存储与检索能力。

**核心特性:**
* **O(log N) 复杂度**: 元素的插入、删除和查找操作的平均时间复杂度为对数级别。
* **后向指针**: 每个节点都包含一个后向指针，支持从后往前的迭代，这对于实现 `ZREVRANGE` 等命令至关重要。
* **跨度（Span）计数**: 每个前向指针都记录了其跨越的节点数量。这个特性使得在 O(log N) 时间复杂度内计算元素的排名（`ZRANK`）成为可能。
* **双重排序**: 元素首先按分数（score）排序；当分数相同时，再按成员（member）的字典序排序，这确保了元素的唯一性和稳定的排序结果。

## 模块在项目中的角色

`redis-common` 是一个纯粹的库模块，不依赖于 `redis-mini` 项目中的任何其他模块。它作为最低层的基础设施，提供了构建所有上层逻辑所必需的核心构件。其高性能和内存效率的设计，对于实现 `redis-mini` 服务器的整体性能目标至关重要。

## 如何构建与测试

该模块可以使用 Maven 独立进行构建和测试。

```bash
# 进入模块根目录
cd redis-common

# 运行测试并安装构建产物
mvn clean install
```