# Redis Mini - Persistence 持久化模块

## 模块概览

`redis-persistence` 模块为 `redis-mini` 项目提供了核心的数据持久化层，确保内存中的数据在服务器重启后依然能够恢复。本模块实现了 Redis 的两种主要持久化机制：AOF (Append Only File) 和 RDB (Redis Database)，为用户在数据安全性与性能之间提供了灵活的选择。

本模块的设计注重高性能、可靠性以及与核心数据模块的解耦。它通过 `redis-core` 模块提供的接口访问需要持久化的数据，并将它们序列化后写入磁盘。

---

## 核心组件与特性

本模块主要由 AOF 和 RDB 两大功能组件构成。

### AOF (Append Only File)

AOF 持久化通过记录服务器执行的所有写操作命令来恢复数据。这种方式提供了更高的数据安全性。

* **`AofManager`**: AOF 功能的中心协调器，负责管理 AOF 文件的加载和写入流程。
* **`AofLoader`**: AOF 加载器。在服务器启动时，它会解析 AOF 文件，将记录的写命令逐条重新执行，从而恢复内存中的数据状态。加载器具备错误容忍性，可以跳过部分损坏的命令，最大限度地恢复数据。
* **`AofBatchWriter`**: 一个高性能的批量写入器。它在后台线程中运行，将多个写命令在内存中聚合成一个批次，然后一次性写入磁盘。这种机制显著减少了磁盘 I/O 次数，大幅提升了 AOF 的写入性能。
* **刷盘策略 (`AofSyncPolicy`)**: 支持多种刷盘策略，允许用户根据业务场景在性能和数据持久性之间进行权衡：
    * `ALWAYS`: 每个命令都立即刷盘，安全性最高。
    * `NO`: 完全依赖操作系统进行刷盘，性能最好。
    * `EVERYSEC`: 每秒进行一次刷盘，权衡安全性和性能。
* **AOF 重写**: 提供了后台重写（`bgrewrite`）机制，可以在不阻塞服务的情况下，生成一个体积更小、内容等价的 AOF 文件，以回收磁盘空间并加速重启时的数据恢复速度。

### RDB (Redis Database)

RDB 持久化通过在指定时间点生成数据集的快照（snapshot）来完成。它生成的是一个非常紧凑的二进制文件，非常适合用于备份和灾难恢复。

* **`RdbManager`**: RDB 功能的中心协调器，管理 RDB 文件的保存、加载和用于主从复制的快照生成。
* **同步与异步保存**:
    * **`writeRdb`**: 同步保存，会阻塞当前线程直到RDB文件生成完毕（类似于 `SAVE` 命令）。
    * **`bgSaveRdb`**: 异步保存，会启动一个后台线程来执行保存操作，主线程不会被阻塞（类似于 `BGSAVE` 命令）。它利用了 `redis-common` 中 `Dict` 提供的写时复制（CoW）快照技术，确保了在保存过程中数据的一致性。
* **`RdbLoader` 与 `RdbWriter`**: 分别负责将内存中的数据对象（如 `RedisString`, `RedisList` 等）序列化为紧凑的RDB格式，以及在启动时从RDB文件反序列化数据并加载到内存中。
* **CRC64 校验**: RDB 文件的末尾包含一个64位的CRC校验和。`RdbLoader` 在加载文件时会严格验证此校验和，以确保RDB文件在传输或存储过程中没有发生损坏，保证了数据的完整性。

## 设计原则

* **解耦**: 持久化模块通过依赖 `RedisCore` 接口来访问数据，而不是其具体实现 `RedisCoreImpl`。这遵循了依赖倒置原则，使得本模块可以独立于核心数据存储的具体实现进行测试和演进。
* **线程安全**: RDB的后台保存 (`bgSaveRdb`) 和AOF的后台重写 (`bgrewrite`) 都是在独立的后台线程中执行的。它们通过获取数据快照的方式来工作，确保了持久化过程不会与主线程的命令处理产生数据竞争。

## 在项目中的角色

`redis-persistence` 是一个关键的服务模块，它被 `redis-server` 模块中的 `RedisContext` 统一管理。它为服务器提供了数据安全保障，并为 `redis-replication` 模块的全量复制提供数据支持。

## 如何构建与测试

该模块可以使用 Maven 独立进行构建和测试。

```bash
# 进入模块根目录
cd redis-persistence

# 运行测试并安装构建产物
mvn clean install
```